<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <!-- 禁止缓存 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>map</title>
    
    <link href="css/iconfont.css" rel="stylesheet" type="text/css" />
    <link href="./css/main.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="js/canvasdomain.js"></script>
    <script type="text/javascript" src="js/jsondomain.js"></script>
    <script type="text/javascript" src="js/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.14"></script>

</head>
<body id="body">

    <div class="sideBox">
      <ul class="nav">
        <li><a id="jingdian">景点</a></li>
        <li><a id="zhusu">住宿</a></li>
        <li><a id="canyin">餐饮</a></li>
        <li><a id="cesuo">厕所</a></li>
      </ul>
    </div>

<!-- 添加左下角标签 -->

<div class="left_img">
    <ul>
        <li id="liebiao" onclick="showLieBiao()"><div class="img"><img src="images/vetorgram/list.png"></div></li>
        <li id="fangda" onclick="fangda()"><div class="img"><img src="images/vetorgram/fangda.png"></div></li>
        <li id="suoxiao" onclick="suoxiao()"><div class="img"><img src="images/vetorgram/suoxiao.png"></div></li>
        <li id="dingwei"><div class="img"><img src="images/vetorgram/dingwei.png"></div></li>
    </ul>   
</div>
<!-- 添加左下角标签end -->
<!-- 添加弹出框div -->
<div class="pop" id="pop" style="display: none;">
    <div class="pop-top" id="pop-top">
     <div class="toplft" style="width: 200px;"><p>景区列表</p></div>
      <div class="toplft" style="width: 200px;"><span class="pop-close" id="closedone"><i class="iconfont icon-cuowu"></i></span></div>
    </div>
    <div class="pop-content" id="pop-content">
        <div class="pop-content-right">
            <p><a href="#">百丈漈</a><b class="lname"></b></p>
            <p><a href="#">铜铃山</a><b class="price"></b></p>
            <p><a href="#">月老山</a><b class="ltime"></b></p>
            <p><a href="#">猴王谷</a><b class="synopsis"></b></p>
            <p><a href="#">安福寺</a><b class="synopsis"></b></p>
            <p><a href="#">刘基故里</a><b class="teasynopsis"></b></p>
            <p><a href="#">朱阳九峰</a><b class="synopsis"></b></p>   
            <p><a href="#">峡谷景廊</a><b class="synopsis"></b></p>
            <p><a href="#">岩门大峡谷</a><b class="teacher"></b></p>     
            <p><a href="#">九溪欢乐谷</a><b class="synopsis"></b></p>   
            <p><a href="androidamap://navi?sourceApplication=appname&poiname=fangheng&lat=36.547901&lon=104.258354&dev=1&style=2">导航</a></p>
        </div>
    </div>
    <div class="pop-foot">
        <input type="button" value="VR实景" class="gotoVR" id="gotoVR" onclick="autoPlay()" />
        <input type="button" value="导航" class="gotoNav" id="gotoNav" onclick="gotoMap()" />
    </div>
</div>
<!-- 添加弹出框div end -->
<!-- 添加弹出介绍div -->
<div class="intr" id="intr" style="display: none;">
   <div class="intr-top">
        <div class="left"><span id="intr_title"></span></div>
        <div class="right"><span id="close_intr" onclick="close_intr()"><i class="iconfont icon-cuowu"></i></span></div>
        <!-- 修改为 icon图标 -->
   </div>
   <div class="intr-body">
       <div class="body_img"><img id="intr_img"></div>
        <div class="bodyright">
            <div class="text"><p id="intr_content"></p></div>
            <div class="intr-foot">
                <button class="btn" id="speak" onclick="autoPlay()">语音</button>
                <button class="btn" id="goto" onclick="gotoMap()">导航</button>
            </div>
        </div>
   </div>
</div>
<!-- 添加弹出介绍div end-->
<!-- 播放MP3 -->
<audio id="myaudio" src="mp3/test1.mp3" controls="controls" loop="false" hidden="true" >
</audio>
<!-- 播放MP3end -->
<!-- 用来append 图片对象 -->
<div id="imglist" style="z-index: 1;"></div>
<!-- canvas层 -->
<canvas id='canvas'>您的浏览器不支持canvas</canvas>

<script type="text/javascript">
var DEF_C = 40075020;//地球赤道位置周长
var mp3list = "mp3/test1.mp3";
    //初始化画布
(function int(){
    canvas=document.getElementById('canvas');
    context=canvas.getContext('2d');
    canvas.width = width;
    canvas.height = height;
    loadImg();
})();
//获取json数据，方便之后使用
(function init_JsonData(){
    // 判断是否是微信端访问，若不是则拒绝访问
    // judgeview();
    readTextFile('json/startPoint.json');
    readTextFile('json/palace.json');
})();


//计算经纬度两点之间的距离
function computeDis(lon1, lat1, lon2, lat2){
    var m1 = new AMap.Marker({
        position: new AMap.LngLat(lon1, lat1)
    });
    var m2 = new AMap.Marker({
        position:new AMap.LngLat(lon2, lat2)
    });
    var p1 = m1.getPosition();
    var p2 = m2.getPosition();
    var distance = Math.round(p1.distance(p2));
   return distance;
}
//经纬度计算方位角。lon1(经度),lat1(纬度)为标准
function getazimuth(lon1, lat1, lon2, lat2){
    // var Aj=121.53721,Aw=29.829484,Bj=121.549777,Bw=29.832009;
    // var Aj=lon1,Aw=lat1,Bj=lon2,Bw=lat2;
    // var Aj=113.14,Aw=23.08,Bj=110.47,Bw=21.26;
// 方位角方法1
    // var cos=Math.cos(90-Bw)*Math.cos(90-Aw)+Math.sin(90-Bw)*Math.sin(90-Aw)*Math.cos(Bj-Aj)
    // var sin =Math.sqrt(1-Math.pow(cos,2));
    // var azimuth = Math.asin((Math.sin(90-Bw)*Math.sin(Bj-Aj))/sin)*180/Math.PI;
    // return azimuth;

// 方位角方法2
    // var tgAAA=(Math.cos(Bw)*Math.sin(Bj-Aj))/(Math.sin(Bw)*Math.cos(Aw)-Math.cos(Bw)*Math.sin(Aw)*Math.cos(Bj-Aj));
    // var azimuth = Math.atan(tgAAA)*180/Math.PI;
    // return azimuth;

// 计算不同维度的地球半径进行勾股计算
    var earthradio = DEF_C * Math.cos(lat1);
    var per_lon_dis = earthradio/360;
    var dis_x =(lon2 - lon1) * per_lon_dis;
    var distance = computeDis(lon1, lat1, lon2, lat2);
    var dis_y = Math.sqrt(Math.abs(Math.pow(distance,2)- Math.pow(dis_x,2)));//计算出来是绝对正值，要进行对比
    if(lat1<lat2)
        dis_y = -dis_y;
    return {
        dis_x:dis_x,
        dis_y:dis_y
    }
}
var dis = getazimuth(120.697878,27.915796,120.709744,27.916243);
console.log("两点相对距离为："+dis.dis_x+" "+dis.dis_y);


//39.94607,116.32793  31.24063,121.42575
// var dis = computeDis(116.32793 ,39.94607,121.42575,31.24063);
// console.log("两点距离为："+computeDis(116.697878,39.916243,120.709744,27.916243));

//阻止底层body滑动
$("canvas").on("touchstart", function(e) {
    e.preventDefault();
});

$("#canvas").bind("touchstart",function(e){
    console.log("start");
    pos = windowToCanvas(canvas,event.changedTouches[0].pageX,event.changedTouches[0].pageY);
    console.log(event.changedTouches[0].pageX);
    // dis_std = Math.sqrt(Math.pow(( event.changedTouches[0].pageX - event.changedTouches[1].pageX),2) + Math.pow((event.changedTouches[0].pageY - event.changedTouches[1].pageY),2));
    if(e.changedTouches.length != 1)
        distance = true;
});
$("#canvas").bind("touchmove",function(e){
    // 约束单指操作，移动图片
    if(e.originalEvent.targetTouches.length == 1)
        {
            canvas.style.cursor="move";
            pos1=windowToCanvas(canvas,e.originalEvent.targetTouches[0].pageX,e.originalEvent.targetTouches[0].pageY);
            var x=pos1.x-pos.x;
            var y=pos1.y-pos.y;
            // console.log(x,y);
            // console.log("imgx,imgy",imgX,imgY);
            // alert("单指操作");


            // // 图片移动范围约束,待完善
            // if(imgX+x > 0||imgY+y>0||imgX+x<window.screen.availWidth-img.width||imgY+y<window.screen.availHeight-img.height)
            //     return 0;

            pos=pos1;
            imgX+=x;
            imgY+=y;
            drawImage();
        }
    // 约束双指操作,调用缩放函数
    if(e.originalEvent.targetTouches.length == 2)
        {   
            //若start初始状态没有两个手指点坐标，则设有两个手指坐标的瞬间作为dis_std的初始状态
            if(!distance)
            {
                distance = true;
                dis_std = Math.sqrt(Math.pow((e.originalEvent.targetTouches[0].pageX - e.originalEvent.targetTouches[1].pageX),2)+Math.pow((e.originalEvent.targetTouches[0].pageY - e.originalEvent.targetTouches[1].pageY),2));
            }
            pageX = e.originalEvent.targetTouches[0].pageX + e.originalEvent.targetTouches[1].pageX ;
            pageY = e.originalEvent.targetTouches[0].pageY + e.originalEvent.targetTouches[1].pageY ;
            // alert("双指操作delta");
            dis_move = Math.sqrt(Math.pow((e.originalEvent.targetTouches[0].pageX - e.originalEvent.targetTouches[1].pageX),2)+Math.pow((e.originalEvent.targetTouches[0].pageY - e.originalEvent.targetTouches[1].pageY),2));
            if(dis_move > dis_std)
                delta = 120;
            else if(dis_move < dis_std)
                delta = -120;
            
        }

    });

$("#canvas").bind("touchend",function(e){
    //弹出数据检查
    // alert("数据：distance="+distance+"；dis_std:"+dis_std+"；dis_move:"+dis_move+"；位移差值："+Math.abs(dis_move - dis_std)+";delta"+delta);
    if(delta!=0 && Math.abs(dis_move - dis_std)>30)
            {
                scale(pageX/2,pageY/2,delta);
            }
    console.log("结束：",e.originalEvent.changedTouches[0].pageX, e.originalEvent.changedTouches[0].pageY);
    $("#canvas").bind("touchmove",function(e){});
    $("#canvas").bind("touchend",function(e){});
    canvas.style.cursor="default";
    distance = false;
    dis_move = 0;
    delta = 0;
});

</script>
<script type="text/javascript" src="js/func.js"></script>
</body>
</html>